#' Filter search result and keep only people
#'
#' @param search A data frame generated by `tw_search()`, or a search query. If a data frame is given, language and limits are ignore.
#' @param p A character vector of length 1, a property. Must always start with the capital letter "P", e.g. "P31" for "instance of".
#' @param q A character vector of length 1, a wikidata id. Must always start with the capital letter "Q", e.g. "Q5" for "human being".
#' @param language Language to be used for the search.
#' @param limit Maximum numbers of responses to be given.
#' @param cache Logical, defaults to TRUE.
#' @param wait In seconds, defaults to 1. Time to wait between queries to Wikidata. If data are cached locally, wait time is not applied.
#'
#' @return A data frame with three columns, `id`, `label`, and `description`, filtered by the above criteria.
#' @export
#'
#' @examples
#'
#' \dontrun{
#' tw_search("Antonio Vivaldi") %>%
#'   tw_filter()
#' }
#'
tw_filter <- function(search,
                      p,
                      q,
                      stop_at_first = TRUE,
                      language = "en",
                      limit = 10,
                      wait = 1,
                      cache = TRUE) {
  if (is.data.frame(search) == TRUE) {
    search_result <- search
  } else if (length(search) > 1) {
    usethis::ui_stop("Input must be a single query or a data frame generated by `tw_search_wiki()`")
  } else if (is.character(search) == TRUE) {
    search_result <- tidywikidatar::tw_search(
      search = search,
      language = language,
      limit = limit,
      wait = 1,
      cache = TRUE
    )
  }
  filtered_id <- purrr::map_dfr(
    .x = search_result$id,
    .f =
      function(current_id) {
        current_value <- tidywikidatar::tw_get_property(id = current_id,
                                                        p = p,
                                                        cache = cache)

        if (is.null(current_value)) {
          tibble::tibble(id = as.character("NA"))
        } else if (length(current_value)==0) {
          tibble::tibble(id = as.character("NA"))
        } else if (is.element(q, current_value)==TRUE) {
          tibble::tibble(id = current_id)
        } else {
          tibble::tibble(id = as.character("NA"))
        }
      }
  ) %>%
    tidyr::drop_na()

  search_result %>%
    dplyr::semi_join(y = filtered_id,
                     by = "id")
}


#' Filter search result and keep only people
#'
#' A wrapper of `tw_filter()` that defaults to keep only "instance of" (P31) "human being" (Q5).
#'
#' @param search A data frame generated by `tw_search()`, or a search query. If a data frame is given, language and limits are ignore.
#' @param language Language to be used for the search.
#' @param stop_at_first Logical, defaults to TRUE. If TRUE, returns only the first match from the search that satisfies the criteria.
#' @param limit Maximum numbers of responses to be given.
#'
#' @return A data frame with three columns, `id`, `label`, and `description`; all rows refer to a human being.
#' @export
#'
#' @examples
#'
#' \dontrun{
#' tw_search("Antonio Vivaldi") %>%
#'   tw_filter_people()
#' }
#'
#'
tw_filter_people <- function(search,
                             language = "en",
                             limit = 10,
                             stop_at_first = TRUE) {
  tidywikidatar::tw_filter(search = search,
                           p = "P31",
                           q = "Q5",
                           stop_at_first = stop_at_first,
                           language = language,
                           limit = 10)
}

